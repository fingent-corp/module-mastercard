<?php
/**
 * Copyright (c) 2016-2019 Mastercard
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// @codingStandardsIgnoreFile

/**
 * @var \Mastercard\Mastercard\Block\Adminhtml\Order\View\Info\Card $block
 */
?>
<?php
    $risk = null;
?>
<?php if (!$block->isPaybylink()): ?>
<div class="admin__page-section-item-content">
    <div class="order-payment-additional" data-mage-init='{"Mastercard_Mastercard/js/order/view/info/details": {}}'>
        <div class="primary">
            <button data-role="tns-full-payment-details-button" type="button" class="button action secondary">
                <span><?= $block->escapeHtml(__('Show Payment Details')) ?></span>
            </button>
        </div>
        <div data-role="tns-full-payment-details-content" style="display: none">
            <table class="data-table admin__table-secondary">
                <tbody>
                    <?php $payment = $block->getPayment(); ?>
                    <?php $info = $payment->getAdditionalInformation(); ?>
                    <tr>
                        <th id="gateway_code"><?= $block->escapeHtml(__('gateway_code')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['gateway_code'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="funding_status"><?= $block->escapeHtml(__('funding_status')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['funding_status'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="txn_result"><?= $block->escapeHtml(__('txn_result')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['txn_result'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="card_scheme"><?= $block->escapeHtml(__('card_scheme')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['card_scheme'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="card_number"><?= $block->escapeHtml(__('card_number')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['card_number'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="card_expiry_date"><?= $block->escapeHtml(__('card_expiry_date')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['card_expiry_date'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <th id="auth_code"><?= $block->escapeHtml(__('auth_code')) ?></th>
                        <td><?= $block->escapeHtml($block->safeValue($info['auth_code'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <td><?= $block->escapeHtml(__('funding_method')) ?></td>
                        <td><?= $block->escapeHtml($block->safeValue($info['fundingMethod'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <td><?= $block->escapeHtml(__('issuer')) ?></td>
                        <td><?= $block->escapeHtml($block->safeValue($info['issuer'] ?? null)) ?></td>
                    </tr>
                    <tr>
                        <td><?= $block->escapeHtml(__('name_on_card')) ?></td>
                        <td><?= $block->escapeHtml($block->safeValue($info['nameOnCard'] ?? null)) ?></td>
                    </tr>
                    <?php if (is_array($block->getRiskData()) && isset($block->getRiskData()['response'])): ?>
                        <?php $risk = $block->getRiskData()['response'] ?>
                        <tr>
                            <td><?= $block->escapeHtml(__('Risk Status')) ?></td>
                            <td><?= $block->escapeHtml($risk['gatewayCode'] ?? '') ?></td>
                        </tr>
                        <tr>
                            <td><?= $block->escapeHtml(__('Total Score')) ?></td>
                            <td><?= $block->escapeHtml($block->safeValue($risk, 'totalScore')) ?></td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>

            <?php if ($risk !== null && isset($risk['review'])): ?>
                <br />
                <table class="data-table admin__table-secondary">
                <caption><h3><?= $block->escapeHtml(__('Decision')) ?></h3></caption>
                    <tbody>
                        <tr>
                            <td><?= $block->escapeHtml(__('Decision')) ?></td>
                            <td><?= $block->escapeHtml($block->safeValue($risk['review'], 'decision')) ?></td>
                        </tr>
                        <tr>
                            <td><?= $block->escapeHtml(__('Decision Reason')) ?></td>
                            <td><?= $block->escapeHtml($block->safeValue($risk['review'], 'decisionReason')) ?></td>
                        </tr>
                        <tr>
                            <td><?= $block->escapeHtml(__('Note')) ?></td>
                            <td><?= $block->escapeHtml($block->safeValue($risk['review'], 'note')) ?></td>
                        </tr>
                        <tr>
                            <td><?= $block->escapeHtml(__('Time Of Decision')) ?></td>
                            <td><?= $block->escapeHtml($block->safeValue($risk['review'], 'timeOfDecision')) ?></td>
                        </tr>
                    </tbody>
                </table>
            <?php endif; ?>

            <?php if ($risk !== null): ?>
                <br />
                <table class="data-table admin__table-secondary">
                <caption><h3><?= $block->escapeHtml(__('Rules')) ?></h3></caption>
                    <thead>
                        <tr>
                            <th><?= $block->escapeHtml(__('Rule')) ?></th>
                            <th><?= $block->escapeHtml(__('Recommendation')) ?></th>
                            <th><?= $block->escapeHtml(__('Score')) ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach($risk['rule'] as $rule): ?>
                            <tr>
                                <td><?= $block->escapeHtml($block->safeValue($rule, 'name')) ?></td>
                                <td><?= $block->escapeHtml($block->safeValue($rule, 'recommendation')) ?></td>
                                <td><?= $block->escapeHtml($block->safeValue($rule, 'score')) ?></td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>
    </div>
</div>
<?php endif; ?>